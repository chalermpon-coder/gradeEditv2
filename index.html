<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการผลการเรียน มส/ร</title>
    <!-- โหลด Tailwind CSS และ PapaParse -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Import deleteDoc for resetting data
        import { getFirestore, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL VARIABLES (Provided by Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let isAuthReady = false;

        // --- Firebase Initialization and Auth ---
        window.initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    console.log("Firebase Auth State Changed. User ID:", user?.uid || 'Anon');
                    window.db = db; // ทำให้ db ใช้ได้ทั่วโลก
                    window.auth = auth; // ทำให้ auth ใช้ได้ทั่วโลก
                    window.userId = user?.uid || crypto.randomUUID();
                    loadDataFromFirestoreOrCSV(); // เริ่มโหลดข้อมูลทันทีที่ Auth พร้อม
                });
            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                document.getElementById('statusMessage').textContent = '⚠️ เกิดข้อผิดพลาดในการเชื่อมต่อฐานข้อมูล';
            }
        };

        window.initFirebase();

        // --- Main Data Handling Functions ---
        
        const DATA_DOC_PATH = (appId) => `artifacts/${appId}/public/data/grade_summary/summary`;
        const CSV_FILENAME = '0รมส - Sheet1.csv'; // ชื่อไฟล์ที่ต้องการดึง

        /**
         * 1. ตรวจสอบข้อมูลใน Firestore
         * 2. ถ้ามี: ดึงข้อมูลจาก Firestore
         * 3. ถ้าไม่มี: ดึงไฟล์ CSV ที่อัปโหลดไว้, ประมวลผล, บันทึกใน Firestore และแสดงผล
         */
        window.loadDataFromFirestoreOrCSV = async () => {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = 'กำลังตรวจสอบข้อมูลที่บันทึกไว้...';

            try {
                const docRef = doc(db, DATA_DOC_PATH(appId));
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && docSnap.data().teacherSummary) {
                    const data = docSnap.data();
                    statusMessage.textContent = `โหลดข้อมูลสำเร็จ! อัปเดตล่าสุด: ${new Date(data.timestamp).toLocaleString('th-TH')}`;
                    window.teacherSummaryMap = new Map(JSON.parse(data.teacherSummary)); // โหลด Map
                    renderSummaryTable(window.teacherSummaryMap);
                } else {
                    statusMessage.textContent = 'ไม่พบข้อมูลที่บันทึกไว้... กำลังประมวลผลจากไฟล์ CSV อัตโนมัติ...';
                    await fetchAndProcessCSV();
                }

                document.getElementById('resultsContainer').classList.remove('hidden');
                document.getElementById('resetButton').classList.remove('hidden');


            } catch (e) {
                statusMessage.textContent = '⚠️ ข้อผิดพลาดในการโหลด/บันทึกข้อมูล กรุณาลองใหม่อีกครั้ง';
                console.error("Firestore operation failed:", e);
                // ในกรณีที่เกิดข้อผิดพลาดกับ Firestore ให้ลองประมวลผลจาก CSV โดยตรง
                await fetchAndProcessCSV();
            }
        };

        /**
         * ดึงไฟล์ CSV ที่อัปโหลดไว้มาประมวลผล
         */
        window.fetchAndProcessCSV = async () => {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = `กำลังประมวลผลไฟล์ใหม่: ${CSV_FILENAME}...`;
            document.getElementById('resetButton').disabled = true; // ปิดปุ่มระหว่างประมวลผล

            try {
                // Fetch CSV content
                const response = await fetch(CSV_FILENAME);
                if (!response.ok) throw new Error('CSV file not found or inaccessible.');
                
                const csvText = await response.text();

                // Parse CSV using PapaParse
                PapaParse.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    encoding: "TIS-620", // สำคัญสำหรับภาษาไทย
                    complete: async function(results) {
                        const summaryMap = processData(results.data);
                        window.teacherSummaryMap = summaryMap; // บันทึกใน window เพื่อใช้ใน function อื่น
                        
                        await saveSummaryToFirestore(summaryMap);
                        renderSummaryTable(summaryMap);
                        statusMessage.textContent = 'ประมวลผลจากไฟล์ CSV และบันทึกข้อมูลเรียบร้อยแล้ว!';
                        document.getElementById('resetButton').disabled = false;
                    },
                    error: function(error) {
                        statusMessage.textContent = `เกิดข้อผิดพลาดในการอ่านไฟล์ CSV: ${error.message}`;
                        console.error("PapaParse Error:", error);
                        document.getElementById('resetButton').disabled = false;
                    }
                });

            } catch (e) {
                statusMessage.textContent = `⚠️ ข้อผิดพลาดในการดึงไฟล์ ${CSV_FILENAME} กรุณาตรวจสอบว่าคุณอัปโหลดไฟล์แล้ว`;
                console.error("Fetch CSV Error:", e);
                document.getElementById('resetButton').disabled = false;
            }
        };

        /**
         * บันทึกข้อมูลสรุปลงใน Firestore
         * @param {Map} summaryMap ข้อมูลสรุป
         */
        async function saveSummaryToFirestore(summaryMap) {
            const summaryObject = {
                teacherSummary: JSON.stringify(Array.from(summaryMap.entries())), // แปลง Map เป็น String
                timestamp: Date.now(),
                appId: appId
            };

            const docRef = doc(db, DATA_DOC_PATH(appId));
            await setDoc(docRef, summaryObject);
        }

        /**
         * ลบข้อมูลเก่าใน Firestore และสั่งประมวลผลไฟล์ CSV ใหม่
         */
        window.deleteAndReloadData = async () => {
            const statusMessage = document.getElementById('statusMessage');
            
            // ใช้คำเตือนแบบ Modal แทน alert()
            const confirmAction = await showCustomConfirmation('คุณแน่ใจหรือไม่?', 'การดำเนินการนี้จะล้างข้อมูลที่บันทึกไว้ทั้งหมด และโหลดไฟล์ CSV ใหม่ คุณต้องการดำเนินการต่อหรือไม่?');

            if (confirmAction) {
                statusMessage.textContent = 'กำลังล้างข้อมูลเก่าในฐานข้อมูล...';
                document.getElementById('resetButton').disabled = true;

                try {
                    const docRef = doc(db, DATA_DOC_PATH(appId));
                    await deleteDoc(docRef);
                    statusMessage.textContent = 'ล้างข้อมูลสำเร็จ! กำลังโหลดไฟล์ใหม่...';
                    
                    // เรียกฟังก์ชันประมวลผลไฟล์ CSV ใหม่
                    await fetchAndProcessCSV();

                } catch (e) {
                    statusMessage.textContent = '⚠️ ข้อผิดพลาดในการล้างข้อมูล Firestore';
                    console.error("Delete Firestore operation failed:", e);
                    document.getElementById('resetButton').disabled = false;
                }
            }
        };

        /**
         * Custom Modal Confirmation (แทน alert/confirm)
         */
        function showCustomConfirmation(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').textContent = message;

                document.getElementById('confirmButton').onclick = () => {
                    modal.classList.add('hidden');
                    resolve(true);
                };
                
                document.getElementById('cancelButton').onclick = () => {
                    modal.classList.add('hidden');
                    resolve(false);
                };

                modal.classList.remove('hidden');
            });
        }

    </script>

    <!-- ส่วนสำหรับโค้ด JS ที่เหลือ (ไม่เกี่ยวกับ Firebase) -->
    <script>
        // Note: The processData and renderSummaryTable functions remain the same as the previous iteration.
        const STATUS = ['มส', 'ร', '0']; // ผลการเรียนที่ต้องการติดตาม

        /**
         * ประมวลผลข้อมูลจาก CSV เพื่อจัดกลุ่มตามครูผู้สอน
         * @param {Array<Object>} data ข้อมูล CSV ที่ถูก Parse แล้ว
         * @returns {Map} teacherSummaryMap
         */
        function processData(data) {
            const teacherSummaryMap = new Map();

            const TEACHER_COL = 'ครูผู้สอน';
            const STUDENT_ID_COL = 'เลขประจำตัว';
            const STUDENT_NAME_COL = 'ชื่อ-นามสกุล';
            const CLASS_COL = 'ชั้น/ห้อง';
            const SUBJECT_CODE_COL = 'รหัสวิชา';
            const SUBJECT_NAME_COL = 'ชื่อวิชา';
            const GRADE_COL = 'ผลการเรียน';

            data.forEach(row => {
                const grade = String(row[GRADE_COL] || '').trim();
                
                if (STATUS.includes(grade) && row[TEACHER_COL]) {
                    const teacherName = String(row[TEACHER_COL]).trim();
                    const studentKey = `${row[STUDENT_ID_COL]}-${row[STUDENT_NAME_COL]}`;

                    if (!teacherSummaryMap.has(teacherName)) {
                        teacherSummaryMap.set(teacherName, {
                            subjects: new Set(),
                            students: new Map()
                        });
                    }

                    const teacherData = teacherSummaryMap.get(teacherName);
                    teacherData.subjects.add(`${row[SUBJECT_CODE_COL]} - ${row[SUBJECT_NAME_COL]} (${row[CLASS_COL]})`);
                    
                    if (!teacherData.students.has(studentKey)) {
                        teacherData.students.set(studentKey, {
                            studentId: row[STUDENT_ID_COL],
                            studentName: row[STUDENT_NAME_COL],
                            class: row[CLASS_COL],
                            grades: []
                        });
                    }
                    
                    teacherData.students.get(studentKey).grades.push({
                        subjectCode: row[SUBJECT_CODE_COL],
                        subjectName: row[SUBJECT_NAME_COL],
                        grade: grade,
                    });
                }
            });

            // แปลง Set และ Map ภายในให้เป็น Array สำหรับ JSON Serialization
            const finalMap = new Map();
            teacherSummaryMap.forEach((data, teacherName) => {
                finalMap.set(teacherName, {
                    subjects: Array.from(data.subjects),
                    // การเรียงลำดับตาม class และ studentId ควรจะถูกเรียกใช้หลังจากดึงข้อมูลจาก Map
                    students: Array.from(data.students.values()).sort((a, b) => a.class.localeCompare(b.class))
                });
            });

            return finalMap;
        }


        /**
         * แสดงผลตารางสรุปครูผู้สอน
         * @param {Map} summaryMap ข้อมูลสรุป
         */
        function renderSummaryTable(summaryMap) {
            const tbody = document.getElementById('teacherSummaryTable').querySelector('tbody');
            tbody.innerHTML = '';
            
            const sortedTeachers = Array.from(summaryMap.entries()).sort((a, b) => {
                return b[1].students.length - a[1].students.length;
            });

            sortedTeachers.forEach(([teacherName, data]) => {
                const studentCount = data.students.length;
                const subjectCount = data.subjects.length;

                const row = tbody.insertRow();
                row.className = 'hover:bg-blue-50 transition duration-150';

                row.insertCell().textContent = teacherName;
                row.insertCell().textContent = subjectCount;
                row.insertCell().textContent = studentCount + ' คน';

                const detailCell = row.insertCell();
                const button = document.createElement('button');
                button.textContent = 'ดูรายละเอียด';
                button.className = 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded text-sm transition duration-150 shadow-md';
                button.addEventListener('click', () => renderStudentDetail(teacherName, data));
                detailCell.appendChild(button);
            });

            document.getElementById('studentDetailContainer').classList.add('hidden');
        }

        /**
         * แสดงรายละเอียดนักเรียนสำหรับครูผู้สอนที่เลือก
         */
        function renderStudentDetail(teacherName, data) {
            const detailHeader = document.getElementById('detailHeader').querySelector('span');
            const studentDetailContainer = document.getElementById('studentDetailContainer');
            const studentDetailDiv = document.getElementById('studentDetail');
            
            studentDetailContainer.classList.remove('hidden');
            detailHeader.textContent = teacherName;
            studentDetailDiv.innerHTML = '';

            const students = data.students.flatMap(student => 
                student.grades.map(grade => ({
                    studentId: student.studentId,
                    studentName: student.studentName,
                    class: student.class,
                    ...grade
                }))
            );

            // จัดเรียงตามชั้น/ห้อง และเลขประจำตัว
            students.sort((a, b) => {
                // Sorting by class first
                const classCompare = a.class.localeCompare(b.class);
                if (classCompare !== 0) return classCompare;
                
                // Then sort by studentId
                return String(a.studentId).localeCompare(String(b.studentId));
            });
            
            const rowsHtml = students.map((student, index) => {
                const gradeClass = student.grade === '0' ? 'text-red-600 font-bold' : 'text-orange-600 font-bold';
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="w-1/12">${index + 1}</td>
                        <td class="w-2/12">${student.studentId}</td>
                        <td class="w-3/12">${student.studentName}</td>
                        <td class="w-1/12">${student.class}</td>
                        <td class="w-3/12">${student.subjectName} (${student.subjectCode})</td>
                        <td class="w-1/12 ${gradeClass}">${student.grade}</td>
                    </tr>
                `;
            }).join('');

            const tableHtml = `
                <table class="min-w-full data-table bg-white rounded-lg overflow-hidden shadow-sm">
                    <thead>
                        <tr>
                            <th class="w-1/12">ลำดับ</th>
                            <th class="w-2/12">เลขประจำตัว</th>
                            <th class="w-3/12">ชื่อ-นามสกุล</th>
                            <th class="w-1/12">ชั้น/ห้อง</th>
                            <th class="w-3/12">วิชา (รหัส)</th>
                            <th class="w-1/12">ผลการเรียน</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rowsHtml}
                    </tbody>
                </table>
            `;

            studentDetailDiv.innerHTML = tableHtml;

            // เลื่อนหน้าจอไปที่ส่วนรายละเอียด
            studentDetailContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>
    <!-- End of JS for Firebase/Data Processing -->

    <style>
        .container-card {
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .data-table th, .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .data-table th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #1f2937;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4 sm:p-8">

    <!-- Custom Confirmation Modal (แทน alert) -->
    <div id="customModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white rounded-lg p-6 shadow-2xl max-w-sm w-full transform transition-all scale-100">
            <h4 id="modalTitle" class="text-xl font-bold text-red-600 mb-4"></h4>
            <p id="modalMessage" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="cancelButton" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">ยกเลิก</button>
                <button id="confirmButton" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">ยืนยันการประมวลผลใหม่</button>
            </div>
        </div>
    </div>
    <!-- End Custom Modal -->

    <div class="w-full max-w-5xl bg-white rounded-xl container-card p-6 md:p-10">
        <h1 class="text-3xl font-bold text-blue-700 mb-2 text-center">
            ระบบสรุปผลการเรียน "มส" และ "ร"
        </h1>
        <p class="text-gray-600 mb-6 text-center">
            ข้อมูลจะถูกโหลดและบันทึกโดยอัตโนมัติ (ดึงจากไฟล์ **0รมส - Sheet1.csv**)
        </p>
        
        <!-- ปุ่มประมวลผลใหม่ -->
        <div class="text-center mb-6">
             <button id="resetButton" onclick="deleteAndReloadData()" class="hidden bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                ประมวลผลไฟล์ใหม่ (รีเซ็ตข้อมูล)
            </button>
        </div>

        <!-- ส่วนสำหรับแสดงข้อความสถานะ / Error -->
        <div id="statusMessage" class="mb-6 text-center text-lg font-medium text-gray-700 min-h-[30px]">
            กำลังเริ่มต้น...
        </div>

        <!-- ส่วนสำหรับแสดงผลลัพธ์หลัก -->
        <div id="resultsContainer" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">
                ตารางสรุปภาระงาน (ครูผู้สอน)
            </h2>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table id="teacherSummaryTable" class="min-w-full data-table">
                    <thead>
                        <tr>
                            <th class="sticky top-0">ครูผู้สอน</th>
                            <th class="sticky top-0">จำนวนวิชาที่ติด</th>
                            <th class="sticky top-0">จำนวนนักเรียน (คน)</th>
                            <th class="sticky top-0">รายละเอียด</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- ข้อมูลจะถูกแทรกที่นี่ -->
                    </tbody>
                </table>
            </div>
            
            <div id="studentDetailContainer" class="mt-8 pt-4 border-t"> <!-- แก้ไข ID ซ้ำซ้อน: ใช้ studentDetailContainer แทน detailView -->
                <h3 class="text-xl font-semibold text-gray-700 mb-4" id="detailHeader">
                    รายละเอียดนักเรียนของครูผู้สอน: <span class="text-blue-600 font-bold">--</span>
                </h3>
                <div id="studentDetail" class="bg-gray-100 p-4 rounded-lg">
                    <p class="text-gray-500 italic">กรุณาคลิกปุ่ม 'ดูรายละเอียด' เพื่อแสดงข้อมูลนักเรียน</p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
