<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการผลการเรียน มส/ร</title>
    <!-- โหลด Tailwind CSS และ PapaParse -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL VARIABLES (Provided by Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        let isAuthReady = false;

        try {
            if (Object.keys(firebaseConfig).length > 0) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set Firebase log level for debugging
                // setLogLevel('debug'); 

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated:", userId);
                    } else {
                        // Sign in with custom token or anonymously
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                                console.log("Signed in with custom token:", userId);
                            } catch (e) {
                                console.error("Error signing in with custom token:", e);
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                                console.log("Signed in anonymously (fallback):", userId);
                            }
                        } else {
                            await signInAnonymously(auth);
                            userId = auth.currentUser.uid;
                            console.log("Signed in anonymously:", userId);
                        }
                    }
                    isAuthReady = true;
                    // Log user ID publicly for multi-user reference
                    const userDisplayElement = document.getElementById('userIdDisplay');
                    if (userDisplayElement) {
                         userDisplayElement.textContent = `User ID: ${userId}`;
                    }
                });
                
            } else {
                 console.warn("Firebase config not found. Running in standalone mode.");
                 isAuthReady = true; // Still allow app to run, but without Firestore features
            }
        } catch (e) {
            console.error("Firebase Initialization Error:", e);
        }
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#059669', // Emerald 600
                        'secondary-gray': '#4b5563', // Gray 600
                    },
                },
            },
            fontFamily: {
                sans: ['Inter', 'Tahoma', 'sans-serif'],
            }
        }
    </script>
    <style>
        /* สไตล์สำหรับตารางให้ดูดี */
        .data-table th, .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.95rem;
        }
        .data-table th {
            background-color: #f3f4f6; /* Light gray header */
            color: #1f2937; /* Dark text */
            font-weight: 600;
            text-align: left;
        }
        .data-table tbody tr:hover {
            background-color: #f9fafb; /* Very light hover effect */
        }
        .data-table-container {
            max-height: 60vh; /* จำกัดความสูงตาราง */
            overflow-y: auto;
        }
        .sticky-header th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .teacher-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .teacher-row:hover {
            background-color: #e0f2f1; /* Light cyan hover for emphasis */
        }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-8">

    <div class="max-w-6xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl">
        <header class="mb-8 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-primary-blue flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                แดชบอร์ดสรุปภาระงาน (มส/ร/0)
            </h1>
            <p id="userIdDisplay" class="text-xs text-gray-400 mt-1">User ID: Loading...</p>
        </header>

        <section id="controlPanel" class="mb-8 p-5 bg-green-50 rounded-lg border border-green-200">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">ตัวกรองข้อมูลและการตั้งค่า</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="md:col-span-2">
                    <label for="csvFileSelect" class="block text-sm font-medium text-gray-700 mb-1">
                        เลือกไฟล์ข้อมูล (.csv): 
                    </label>
                    <div class="flex">
                        <select id="csvFileSelect" class="mt-1 block w-full rounded-l-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue p-2.5 bg-white border">
                            <option value="0รมส - Sheet1.csv">0รมส - Sheet1.csv (ค่าเริ่มต้น)</option>
                            <option value="0db.csv">0db.csv</option>
                        </select>
                        <button id="loadDataButton" class="mt-1 bg-primary-blue hover:bg-emerald-700 text-white font-bold py-2 px-3 rounded-r-md shadow-sm transition duration-150 ease-in-out whitespace-nowrap">
                            โหลดข้อมูล
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1" id="currentLoadedFile">
                        กำลังแสดงข้อมูลจากไฟล์: <span class="font-medium text-gray-900">0รมส - Sheet1.csv</span>
                    </p>
                </div>

                <div>
                    <label for="teacherFilter" class="block text-sm font-medium text-gray-700 mb-1">กรองตามครูผู้สอน:</label>
                    <select id="teacherFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue p-2.5 bg-white border">
                        <option value="">-- แสดงทั้งหมด --</option>
                        <!-- ตัวเลือกครูผู้สอนจะถูกเพิ่มที่นี่ -->
                    </select>
                </div>
                <div>
                    <label for="gradeFilter" class="block text-sm font-medium text-gray-700 mb-1">กรองตามผลการเรียน:</label>
                    <select id="gradeFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue p-2.5 bg-white border">
                        <option value="">-- มส, ร, 0 ทั้งหมด --</option>
                        <option value="มส">มส</option>
                        <option value="ร">ร</option>
                        <option value="0">0</option>
                    </select>
                </div>
            </div>
            <div class="mt-4">
                <p id="totalRecords" class="text-sm font-medium text-gray-600">
                    จำนวนรายการนักเรียนทั้งหมด: 0 รายการ
                </p>
            </div>
        </section>

        <div id="loadingMessage" class="text-center p-8 text-xl font-medium text-primary-blue">
            <svg class="animate-spin h-6 w-6 mr-3 inline text-primary-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            กำลังโหลดและประมวลผลข้อมูล...
        </div>

        <div id="resultsContainer" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">
                ตารางสรุปภาระงาน (ครูผู้สอน)
            </h2>
            <div class="data-table-container rounded-lg shadow-xl border">
                <table id="teacherSummaryTable" class="min-w-full bg-white data-table">
                    <thead class="sticky-header">
                        <tr>
                            <th>ครูผู้สอน</th>
                            <th>จำนวนวิชาที่ติด</th>
                            <th>จำนวนนักเรียน (คน)</th>
                            <th>รายละเอียด</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- ข้อมูลจะถูกแทรกที่นี่ -->
                    </tbody>
                </table>
            </div>
            
            <div id="detailView" class="mt-8 pt-4 border-t border-gray-200" id="studentDetailContainer">
                <h3 class="text-xl font-semibold text-gray-700 mb-4" id="detailHeader">
                    รายละเอียดนักเรียนของครูผู้สอน: <span class="text-primary-blue font-bold" id="selectedTeacherName">--</span>
                </h3>
                <div id="studentDetail" class="bg-gray-100 p-4 rounded-lg shadow-inner data-table-container">
                    <p class="text-gray-500 italic">กรุณาคลิกที่ชื่อครูผู้สอนในตารางด้านบนเพื่อแสดงข้อมูลนักเรียน</p>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        // *** โค้ด JavaScript หลัก ***

        const globalState = {
            allRecords: [],             // ข้อมูลทั้งหมดจาก CSV
            teacherSummary: {},         // สรุปข้อมูลตามครูผู้สอน
            selectedTeacher: null,      // ครูผู้สอนที่ถูกเลือกดูรายละเอียด
            currentFileName: '0รมส - Sheet1.csv', // ชื่อไฟล์ปัจจุบัน
        };

        const elements = {
            loadingMessage: document.getElementById('loadingMessage'),
            resultsContainer: document.getElementById('resultsContainer'),
            teacherSummaryTableBody: document.querySelector('#teacherSummaryTable tbody'),
            studentDetail: document.getElementById('studentDetail'),
            selectedTeacherName: document.getElementById('selectedTeacherName'),
            detailHeader: document.getElementById('detailHeader'),
            teacherFilter: document.getElementById('teacherFilter'),
            gradeFilter: document.getElementById('gradeFilter'),
            totalRecords: document.getElementById('totalRecords'),
            csvFileSelect: document.getElementById('csvFileSelect'), // เพิ่มตัวเลือกไฟล์
            loadDataButton: document.getElementById('loadDataButton'), // เพิ่มปุ่มโหลด
            currentLoadedFile: document.getElementById('currentLoadedFile').querySelector('span'),
        };
        
        // CSV Headers (ชื่อคอลัมน์ภาษาไทย)
        const HEADERS = [
            'รหัสวิชา', 'ชื่อวิชา', 'ชั้น/ห้อง', 'ครูผู้สอน', 
            'เลขประจำตัว', 'ชื่อ-นามสกุล', 'เลขที่', 'ปีการศึกษา', 
            'ภาคเรียนที่', 'ผลการเรียน'
        ];

        /**
         * ฟังก์ชันแสดงข้อความแจ้งเตือน/ข้อผิดพลาดในรูปแบบ Modal
         * @param {string} title 
         * @param {string} message 
         * @param {string} type 'success' | 'error' | 'info'
         */
        function showModalMessage(title, message, type = 'info') {
            const colorClass = {
                'error': 'text-red-600',
                'success': 'text-green-600',
                'info': 'text-blue-600'
            }[type];
            const icon = {
                 'error': '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                 'success': '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                 'info': '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
            }[type];

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                    <div class="flex items-center mb-3">
                         ${icon}
                        <h3 class="text-lg font-bold ${colorClass}">${title}</h3>
                    </div>
                    <p class="text-gray-700 text-sm mt-1">${message}</p>
                    <button class="mt-4 bg-primary-blue hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded transition duration-150 shadow-md w-full" onclick="this.parentElement.parentElement.remove()">ตกลง</button>
                </div>
            `;
            document.body.appendChild(modal);
        }


        /**
         * 1. โหลดข้อมูล CSV จากไฟล์ที่อัปโหลด
         */
        async function loadCSVData(fileName) {
            
            globalState.currentFileName = fileName;
            elements.currentLoadedFile.textContent = fileName;
            
            elements.loadingMessage.classList.remove('hidden');
            elements.resultsContainer.classList.add('hidden');
            elements.loadingMessage.innerHTML = `
                <svg class="animate-spin h-6 w-6 mr-3 inline text-primary-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                กำลังโหลดและประมวลผลข้อมูลจากไฟล์ ${fileName}...
            `;

            // 1. URL-encode ชื่อไฟล์
            const encodedFileName = encodeURIComponent(fileName);
            const fetchUri = 'uploaded:' + encodedFileName;

            console.log("Attempting to fetch URI:", fetchUri);

            try {
                const response = await fetch(fetchUri);

                if (!response.ok) {
                    // หาก fetch สำเร็จแต่สถานะไม่ OK (เช่น 404, 500)
                    throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
                }
                
                const uploadedCSVContent = await response.text();

                return new Promise((resolve) => {
                    Papa.parse(uploadedCSVContent, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            // ปรับ key ให้เป็นภาษาไทยตามที่กำหนดใน HEADERS
                            const mappedData = results.data.map(row => {
                                const newRow = {};
                                // พยายามหาค่าในคอลัมน์ภาษาไทยจาก header ที่ PapaParse สร้างขึ้น
                                HEADERS.forEach(thaiKey => {
                                    const value = row[thaiKey];
                                    newRow[thaiKey] = (value || '').trim();
                                });

                                // Fallback: หาก column headers ไม่ตรงเป๊ะ (เกิดขึ้นได้เมื่อ header แตกต่างกัน)
                                // เราจะใช้ index แทน (สมมติว่าลำดับยังคงเดิม: รหัส, ชื่อวิชา, ชั้น/ห้อง, ครูผู้สอน, ...)
                                if (!newRow['รหัสวิชา'] && results.meta.fields) {
                                    const originalKeys = results.meta.fields;
                                    HEADERS.forEach((thaiKey, index) => {
                                        if (index < originalKeys.length) {
                                            const originalKey = originalKeys[index];
                                            const value = row[originalKey];
                                            // ใช้ค่าจาก key ที่ PapaParse อ่านได้ (ซึ่งอาจเป็นภาษาไทยหรืออังกฤษ ขึ้นอยู่กับไฟล์)
                                            newRow[thaiKey] = (newRow[thaiKey] || (value || '')).trim(); 
                                        }
                                    });
                                }

                                return newRow;
                            }).filter(row => row['ผลการเรียน'] && ['มส', 'ร', '0'].includes(row['ผลการเรียน']));
                            
                            globalState.allRecords = mappedData;
                            resolve();
                        },
                        error: function(error) {
                            console.error("Error parsing CSV:", error);
                            showModalMessage("ข้อผิดพลาดในการประมวลผล", "ไม่สามารถประมวลผลไฟล์ CSV ได้ โปรดตรวจสอบรูปแบบไฟล์ว่าเป็น CSV ที่ถูกต้องหรือไม่", 'error');
                            resolve(); // ยังคง resolve เพื่อให้ initialize ทำงานต่อ
                        }
                    });
                });
            } catch (error) {
                // หากเกิด Error (เช่น 404, Failed to fetch)
                console.error("Error fetching CSV file:", error);
                
                let errorMessage = `ไม่สามารถโหลดไฟล์ <b>${fileName}</b> ได้`;
                if (error.message.includes("HTTP Error")) {
                     errorMessage += `<br>สถานะ: ${error.message}`;
                } else if (error.message.includes("Failed to fetch")) {
                     errorMessage += `<br><b>โปรดตรวจสอบว่าได้อัปโหลดไฟล์ชื่อ '${fileName}' อย่างถูกต้องแล้ว</b>`;
                }

                showModalMessage("ข้อผิดพลาดในการโหลดไฟล์", errorMessage, 'error');
                
                // ตั้งค่า records เป็นว่างเพื่อป้องกันการทำงานที่ไม่จำเป็น
                globalState.allRecords = []; 
                elements.loadingMessage.classList.remove('hidden');
                elements.resultsContainer.classList.add('hidden');
                elements.loadingMessage.innerHTML = `ไม่สามารถโหลดข้อมูล CSV ได้<br>โปรดตรวจสอบว่าได้อัปโหลดไฟล์ <b>${fileName}</b> แล้ว`;
            }
        }
        
        /**
         * 2. ประมวลผลข้อมูลเพื่อสร้างตารางสรุป
         */
        function processData() {
            const summary = {};
            
            // 1. กรองข้อมูลตาม Filter ที่เลือก
            const selectedGrade = elements.gradeFilter.value;
            let filteredRecords = globalState.allRecords;

            if (selectedGrade) {
                filteredRecords = filteredRecords.filter(record => record['ผลการเรียน'] === selectedGrade);
            }
            
            // 2. สรุปข้อมูลตามครูผู้สอน
            filteredRecords.forEach(record => {
                // ต้องมีการลบเลขลำดับหน้าชื่อครูออก เช่น "1.นางชลธิรา ผินโพธิ์" ให้เหลือแค่ "นางชลธิรา ผินโพธิ์"
                const rawTeacherName = record['ครูผู้สอน'];
                // ใช้ regex เพื่อลบเลขนำหน้า เช่น '1.' หรือ '10.' ออก
                const teacherName = rawTeacherName ? rawTeacherName.replace(/^\d+\.\s*/, '').trim() : 'ไม่ระบุครูผู้สอน';
                
                if (!summary[teacherName]) {
                    summary[teacherName] = {
                        totalStudents: new Set(),
                        totalSubjects: new Set(),
                        records: [], // เก็บรายการทั้งหมดของครูคนนี้
                    };
                }
                
                // ใช้ Set เพื่อไม่ให้ซ้ำ
                const studentKey = `${record['เลขประจำตัว']}-${record['ชื่อ-นามสกุล']}`;
                const subjectKey = `${record['รหัสวิชา']}-${record['ชื่อวิชา']}`;
                
                summary[teacherName].totalStudents.add(studentKey);
                summary[teacherName].totalSubjects.add(subjectKey);
                summary[teacherName].records.push(record);
            });
            
            globalState.teacherSummary = summary;
            
            // อัปเดตจำนวนรายการทั้งหมด
            elements.totalRecords.textContent = `จำนวนรายการนักเรียนที่ติด มส/ร/0: ${filteredRecords.length} รายการ (จากไฟล์ ${globalState.currentFileName})`;

            // 3. อัปเดตตัวกรองครูผู้สอน
            // รีเซ็ตตัวกรองครูผู้สอนก่อนทุกครั้งที่ประมวลผลใหม่ 
            const currentSelectedTeacher = elements.teacherFilter.value;
            elements.teacherFilter.innerHTML = '<option value="">-- แสดงทั้งหมด --</option>';
            
            const teacherNames = Object.keys(summary).sort();
            teacherNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                if (name === currentSelectedTeacher) {
                    option.selected = true;
                }
                elements.teacherFilter.appendChild(option);
            });


            // 4. แสดงผลตาราง
            renderSummaryTable();
        }

        /**
         * 3. แสดงผลตารางสรุปภาระงาน
         */
        function renderSummaryTable() {
            elements.teacherSummaryTableBody.innerHTML = '';
            const selectedFilterTeacher = elements.teacherFilter.value;
            
            // กรองครูผู้สอนที่ไม่ระบุชื่อออกก่อนแสดงผล
            const validTeacherNames = Object.keys(globalState.teacherSummary).filter(name => name !== 'ไม่ระบุครูผู้สอน');
            let sortedTeacherNames = validTeacherNames.sort();

            // หากมีครูผู้สอนที่ไม่ระบุชื่อ ให้เพิ่มไว้ท้ายตาราง
            if (globalState.teacherSummary['ไม่ระบุครูผู้สอน']) {
                sortedTeacherNames.push('ไม่ระบุครูผู้สอน');
            }
            
            let totalRowsDisplayed = 0;
            sortedTeacherNames.forEach(teacherName => {
                const summary = globalState.teacherSummary[teacherName];

                // กรองตามตัวเลือกของครูผู้สอน
                if (selectedFilterTeacher && selectedFilterTeacher !== teacherName) {
                    return;
                }

                const row = document.createElement('tr');
                row.className = 'teacher-row border-b border-gray-100';
                row.dataset.teacher = teacherName;
                row.onclick = () => showDetail(teacherName);
                
                row.innerHTML = `
                    <td class="font-medium text-gray-900">${teacherName}</td>
                    <td>${summary.totalSubjects.size}</td>
                    <td>${summary.totalStudents.size} คน</td>
                    <td>
                        <button class="bg-primary-blue hover:bg-emerald-700 text-white font-bold py-1.5 px-3 rounded text-sm shadow-md transition duration-150 ease-in-out" onclick="event.stopPropagation(); showDetail('${teacherName}');">
                            ดูรายละเอียด
                        </button>
                    </td>
                `;
                elements.teacherSummaryTableBody.appendChild(row);
                totalRowsDisplayed++;
            });

            if (totalRowsDisplayed === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="4" class="text-center py-4 text-gray-500 italic">ไม่พบข้อมูลตามตัวกรองที่กำหนด</td>`;
                elements.teacherSummaryTableBody.appendChild(emptyRow);
            }

            // ซ่อน/แสดงส่วนผลลัพธ์
            if (globalState.allRecords.length > 0 && totalRowsDisplayed > 0) {
                elements.loadingMessage.classList.add('hidden');
                elements.resultsContainer.classList.remove('hidden');
            } else if (globalState.allRecords.length > 0) {
                // ข้อมูลถูกโหลดแล้ว แต่ไม่มีรายการตามตัวกรอง
                elements.loadingMessage.classList.add('hidden');
                elements.resultsContainer.classList.remove('hidden');
            } else {
                // โหลดข้อมูลไม่สำเร็จ
                elements.loadingMessage.classList.remove('hidden');
                elements.resultsContainer.classList.add('hidden');
            }
        }

        /**
         * 4. แสดงผลรายละเอียดนักเรียนของครูผู้สอนที่เลือก
         * @param {string} teacherName 
         */
        function showDetail(teacherName) {
            globalState.selectedTeacher = teacherName;
            elements.selectedTeacherName.textContent = teacherName;

            const detailData = globalState.teacherSummary[teacherName]?.records || [];
            
            if (detailData.length === 0) {
                elements.studentDetail.innerHTML = `<p class="text-gray-500 italic">ไม่พบข้อมูลนักเรียนที่ติด มส/ร/0 ของครูผู้สอนท่านนี้</p>`;
                return;
            }

            // สร้างตารางรายละเอียด
            let tableHTML = `
                <div class="overflow-x-auto rounded-lg shadow-lg border border-gray-200">
                    <table class="min-w-full bg-white data-table">
                        <thead>
                            <tr class="bg-gray-200">
                                <th>รหัสวิชา</th>
                                <th>ชื่อวิชา</th>
                                <th>ชั้น/ห้อง</th>
                                <th>เลขที่</th>
                                <th>ชื่อ-นามสกุล</th>
                                <th>ผลการเรียน</th>
                                <th class="text-center">ปี/ภาค</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            detailData.sort((a, b) => {
                // จัดเรียงตามชั้น/ห้อง และ เลขที่
                if (a['ชั้น/ห้อง'] < b['ชั้น/ห้อง']) return -1;
                if (a['ชั้น/ห้อง'] > b['ชั้น/ห้อง']) return 1;
                return parseInt(a['เลขที่']) - parseInt(b['เลขที่']);
            });

            detailData.forEach(record => {
                const gradeClass = {
                    'มส': 'bg-red-100 text-red-800 font-bold px-2 py-0.5 rounded-full text-xs',
                    'ร': 'bg-yellow-100 text-yellow-800 font-bold px-2 py-0.5 rounded-full text-xs',
                    '0': 'bg-indigo-100 text-indigo-800 font-bold px-2 py-0.5 rounded-full text-xs',
                }[record['ผลการเรียน']] || 'bg-gray-100 text-gray-800 px-2 py-0.5 rounded-full text-xs';

                tableHTML += `
                    <tr>
                        <td>${record['รหัสวิชา']}</td>
                        <td>${record['ชื่อวิชา']}</td>
                        <td>${record['ชั้น/ห้อง']}</td>
                        <td>${record['เลขที่']}</td>
                        <td class="whitespace-nowrap">${record['ชื่อ-นามสกุล']}</td>
                        <td><span class="${gradeClass}">${record['ผลการเรียน']}</span></td>
                        <td>${record['ปีการศึกษา']}/${record['ภาคเรียนที่']}</td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            elements.studentDetail.innerHTML = tableHTML;
            // เลื่อนไปที่ส่วนแสดงรายละเอียด
            document.getElementById('detailView').scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * จัดการการโหลดข้อมูลเมื่อผู้ใช้กดปุ่ม Load Data
         */
        async function handleLoadData() {
            const selectedFile = elements.csvFileSelect.value;
            if (selectedFile === globalState.currentFileName) {
                showModalMessage("ข้อมูลล่าสุด", `กำลังแสดงข้อมูลจากไฟล์ ${selectedFile} อยู่แล้ว`, 'info');
                return;
            }

            // รีเซ็ตตัวกรองเมื่อเปลี่ยนไฟล์
            elements.teacherFilter.value = '';
            elements.gradeFilter.value = '';
            
            await loadCSVData(selectedFile);
            processData();
            showModalMessage("โหลดข้อมูลสำเร็จ", `โหลดข้อมูลจากไฟล์ <b>${globalState.currentFileName}</b> เสร็จสมบูรณ์`, 'success');
        }

        /**
         * เริ่มต้นการทำงาน
         */
        async function initialize() {
            // โหลดข้อมูล CSV จากไฟล์เริ่มต้น
            await loadCSVData(elements.csvFileSelect.value);
            
            // ประมวลผลและแสดงผลครั้งแรก
            processData();
            
            // เพิ่ม Event Listeners สำหรับตัวกรอง
            elements.teacherFilter.addEventListener('change', processData);
            elements.gradeFilter.addEventListener('change', processData);
            
            // เพิ่ม Event Listener สำหรับปุ่มโหลดข้อมูล
            elements.loadDataButton.addEventListener('click', handleLoadData);

            // ซ่อนข้อความโหลด (ถ้าข้อมูลถูกโหลดสำเร็จ)
            if (globalState.allRecords.length > 0) {
                elements.loadingMessage.classList.add('hidden');
                elements.resultsContainer.classList.remove('hidden');
            }
        }

        // ทำให้ฟังก์ชัน showDetail สามารถเรียกใช้ได้จากปุ่มในตาราง
        window.showDetail = showDetail;

        // เริ่มต้นการทำงานเมื่อหน้าเว็บโหลดเสร็จ
        window.onload = initialize;

    </script>

</body>
</html>
